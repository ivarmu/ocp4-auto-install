---

- name: '[COMMON] Create a directory for the installation'
  file:
    name: "{{ user_path }}"
    state: directory

- name: '[INSTALL_CONFIG] Create bin directory'
  file:
    path: "{{ user_path }}/.ssh"
    state: directory

- name: '[INSTALL_CONFIG] [PREREQS] Copy python prerequisites file'
  copy:
    src: "{{ reqfile.filename }}"
    dest: "{{ user_path }}/{{ reqfile.filename }}"
  loop:
    - { filename: './requirements_kubernetes.txt' }
    - { filename: './requirements_vcenter.txt' , vcenter_reqs: "{{ cloud_provider is match('vcenter') }}" }
  loop_control:
    loop_var: reqfile
  when: reqfile.vcenter_reqs | default(True) | bool

- name: '[INSTALL_CONFIG] [PREREQS] Install python prerequisites'
  pip:
    requirements: "{{ user_path }}/{{ installreqfile.filename }}"
  loop:
    - { filename: 'requirements_kubernetes.txt' }
    - { filename: 'requirements_vcenter.txt' , vcenter_reqs: "{{ cloud_provider is match('vcenter') }}" }
  loop_control:
    loop_var: installreqfile
  when: installreqfile.vcenter_reqs | default(True) | bool

- name: '[INSTALL_CONFIG] Generate SSH keys'
  openssh_keypair:
    type: ed25519
    path: "{{ user_path }}/.ssh/id_rsa"

- name: '[INSTALL_CONFIG] Slurp public key'
  slurp:
    path: "{{ user_path }}/.ssh/id_rsa.pub"
  register: idrsapub

